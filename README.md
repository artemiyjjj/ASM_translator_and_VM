
# ASM. Транслятор и модель

- P33302, Романов Артемий Ильич
- asm | acc | neum | hw | tick | struct | trap | port | pstr | prob1 | spi
- С усложнением

## Язык программирования

### Расширенная форма Бэкуса-Наура

``` EnhancedBackusNaurForm
programm ::= [section .data], section .text;

    section .data ::=  (label, ":") (<amount of memory words> | <number>, ",", '"', <string>, '"' |
    <number | char>, {"," <number | char | string>});

    section .text ::= <label _start>, ":", +{statement} ;

    statement ::= [label, ":"], [instruction], [comment] ;

    instruction ::= no operand instruction | unary instruction, operand ;

    no operand instruction ::= "hlt" | "eni" | "dii" | "inc" | "dec" ;

    unary instruction ::= "ld" | "st" | "add" | "sub" | 
        "mul" | "div" | "cmp" | "or" | "and" | "jmp" | "jz"
        | "jnz" | "jn" | "jnn" | "int" | "out" | "in" ;

    operand ::= number | label ;

    label ::= (<letter> | "_") ({<letter> | <digit> | "_"})

    comment ::= ";", {<any character>}
```

Код программы выполняется последовательно. Одна инструкция определяет одну машинную команду.

Программа поделена на 3 секции: .data, .text. Каждая секция определяет определенную группу данных и располагается в отдельной части памяти, занимаемой программой. Поддерживается прямой и косвенный способы адресации - в первом случае лэйбл или адрес памяти будет интерпретирован непостредственно как адрес памяти, во втором случае - как значение, лежащее по этому лейблу или адресу.

- Секция .data содержит объявления и определения данных с уникальными лейблами. Можно располагать массивы данных одинкаового размера после одной общей метки через запятую.

- Секция .text содержит инструкции, определяющие операции, совершаемые программой, а также лейблы и комментарии.

Лейблы - названия буквенных меток, указывающих на какой-либо адрес в памяти. Заменяются числовыми адресами на этапе трансляции.

Инструкция может быть двух видов:

- без операндов (не требующая аргументов)

- унарной (требовать 1 аргумент)

Аргументы могут быть значениями, указателями на адрес и значениями по адресу.  
Для обращения к памяти косвенным споссобом, перед адресом памяти или лейблом используется префикс "*".

Операнды используют директивы для определения длины слова. Возможная длина: 8 бит (db), 16 бит (dw), 32 бит (dd). По умолчанию, если директива не указана явно, используется директива dd.  

Используемая стратегия вычислений - вызов по значению, т. к. при всех операциях происходит передача значений по шинам данных и значения в регистрах, памяти и модуле управления при передаче данных не изменяются. Вычисление выражения происходит до выполнения операции.

Память выделяется статически, при запуске модели.  
Видимость данных - глобальная.  
Использование pstr с 4-байтовом префиксом возможно на этапе написания программы. Программист может объявлять данные, конкатенируя их через запятую после лейбла. Для объявления p-строки нужно сконкатенировать длину строки с самой строкой (см. файл [hello.asm](/examples/hello.asm)).

## Организация памяти

Модель памяти процессора:

- Общая память для команд и для данных.
- Машинное слово - 32 бита, знаковое.
- Линейное адресное пространство.

## Система команд

Особенности процессора:

- Машинное слово - 32 бит, знаковое.
- Доступ к памяти осуществляется по адресу, хранящемуся в регистре AR (adress register)

## Набор инструкций

| Оператор | Инструкция | Операнды | Кол-во тактов | Описание |  
|---|---|---|---|---|  
| ld | Load | адрес | ? | Загрузка в аккумулятор значения из памяти по указанному адресу |  
| st | Store | адрес | ? | Запись в память по указанному адресу значения из аккумулятора |
| add | Addition | значение по адресу / значение | ? | Сложение значения параметра с значением из аккумулятора с последующей записью результата в аккумулятор |  
| sub | Substraction | значение по адресу / значение | ? | Вычитание значения параметра из значения из аккумулятора с последующей записью результата в аккумулятор |  
| mul | Multiplication | значение по адресу / значение | ? | Умножение значения параметра с значением из аккумулятора с последующей записью в аккумулятор |  
| div | Division | значение по адресу / значение | ? | Деление значения из аккумулятора с значением параметра с последующей записью в аккумулятор |  
| or | Logical "Or" | значение по адресу / значение | ? | Логическое "ИЛИ" между аккумулятором и значением параметра с последующей записью результата в аккумулятор. |  
| and | Logical "And" | значение по адресу / значение | ? | Логическое "И" между аккумулятором и значением параметра с последующей записью в аккумулятор. |  
| jmp | Jump | адрес / значение по адресу | ? | Безусловное изменение значения регистра-указателя команд (IP) на значение параметра. |  
| jz | Jump if Zero | адрес / значение по адресу | ? | Изменение значения регистра IP на значение параметра при значении 1 в регистре Z. |  
| jnz | Jump if Not Zero | адрес / значение по адресу | ? | Изменение значения регистра IP на значение параметра при значении 0 в регистре Z. |  
| jn | Jump if Negative | адрес / значение по адресу | ? | Изменение значения регистра IP на значение параметра при значении 1 в регистре N. |  
| jp | Jump if Positive | адрес / значение по адресу | ? | Изменение значения регистра IP на значение параметра при значении 0 в регистре N. |  
| int | interuption |  | ? | Вызов определенного вектора прерываний |  
| eni | enable interution |  | ? | Разрешить прерывания |  --возможно лишнее
| dii | disable interuption |  | ? | Запретить прерывания |  --возможно лишнее

## Кодирование инструкций

- Машинный код сериализуется в список формата JSON.
- Один элемент списка - одна машинная инструкция.
- Индекс списка - адрес инструкции в памяти и адрес инструкции в машинном коде. Используется для команд перехода.

Пример:

``` machine code
[
    {
        "index": 0,
        "opcode": "jmp",
        "arg": 1,
        "mode": "deref",
        "sc_ref": {
            "line": 2
        }
    },
    {
        "index": 1,
        "label": "a",
        "value": "x",
        "sc_ref": {
            "line": 4
        }
    }
]
```

В примере, представленом выше:

- opcode - строка с кодом инструкции.
- arg - аргумент, если имеется.
- position - местоположение инструкции в исходном коде программы.

Типы данных для реализации инструкций (файл [isa.py](/src/isa.py)):

- Opcode - перечисление кодов инструкций.
- StatementTerm - структура для описания местоположения позиции инструкции в исходном коде. ???

## Транслятор

...

Примечание: вопросы отображения переменных на регистры опущены из-за отсутствия оных.

## Модель процессора

### DataPath

...

### Control Umit


## Тестирование


