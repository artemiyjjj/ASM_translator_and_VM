
# ASM. Транслятор и модель

- P33302, Романов Артемий Ильич
- asm | acc | neum | hw | tick | struct | trap | port | pstr | prob1 | spi
- С усложнением

## Язык программирования

### Расширенная форма Бэкуса-Наура

``` ebnf
programm ::= [section .bss], [section .data], section .text;
    
    section .bss ::=  {label, ":", directive};

    section .data ::=  ;

    section .text ::= <label _start>, ":", +{statement} ;

    statement ::= [label, ":"], [instruction], [comment] ;

    instruction ::= no operand instruction |
        unary instruction, derictive,
        ( first type operand | second type operand ) ;

    no operand instruction ::= "hlt" | "eni" | "dii" | "inc" | "dec" ;

    unary instruction ::= "ld" | "st" | "add" | "sub" | 
        "mul" | "div" | "jmp" | "je" | "jne" | "jz"
        | "jnz" | "int" |;

    first type operand ::= register | label | ;

    second type operand ::= number | first operand ;

    register ::= "AC" | "IP" | "IR" | "AR" | "" | ;

    derictive ::= "db" | "dw" | "dq" ;

    label ::= (<letter> | "_") ({<letter> | <digit> | "_"})

    comment ::= ";", {<any character>}
```

Код программы выполняется последовательно. Одна инструкция определяет одну машинную команду.  
Программа поделена на 3 секции: .bss, .data, .text. Каждая секция определяет определенную группу данных и располагается в отдельной части памяти, занимаемой программой.

- Секция .bss содержит объявления данных с уникальными лейблами. Данные не инициализированны на момент запуска программы и могут определяться в течение работы программы.

- Секция .data содержит определения данных с уникальными лейблами. Данные инициализированы на момент запуска программы.

- Секция .text содержит инструкции, определяющие операции, совершаемые программой, а также лейблы и комментарии.

Лейблы - названия буквенных меток, указывающих на какой-либо адрес в памяти. Заменяются числовыми адресами на этапе трансляции.

Инструкция может быть без операндов или унарной, т. е. либо не требовать аргументов, либо требовать 1 аргумент.

Операнды используют директивы для определения длины слова. Возможная длина: 8 бит (db), 16 бит (dw), 32 бит (dd). По умолчанию, используется директива dd.

Память выделяется статически, при запуске модели. Видимость данных - глобальная. Реализована поддержка pstr с 8-битным префиксом.

## Организация памяти

Модель памяти процессора:

- Общая память для команд и для данных.
- Машинное слово - 32 бита, знаковое.
- Линейное адресное пространство.

## Система команд

Особенности процессора:

- Машинное слово - 32 бит, знаковое.
- Доступ к памяти осуществляется по адресу, хранящемуся в регистре AR (adress register)

## Набор инструкций

| Язык | Инструкция | Операнды | Кол-во тактов | Описание |  
|---|---|---|---|---|  
| ld | Load | адрес | ? | Загрузка в аккумулятор значения из памяти по указанному адресу |  
| st | Store | | ? | Запись в память по указанному адресу значения из аккумулятора |
| add | Addition | | ? | Сложение значения по указанному адресу памяти с значением из аккумулятора с последующей записью результата в аккумулятор |  
| sub | Substraction |  | ? | Вычитание значения по указанному адресу памяти из значения из аккумулятора с последующей записью результата в аккумулятор |  
| mul | Multiplication |  | ? | Умножение значения по указанному адресу памяти с значением из аккумулятора с последующей записью в аккумулятор |  
| div | Division |  | ? | Деление значения из аккумулятора с значением по указанному адресу памяти с последующей записью в аккумулятор |  
| or | Logical Or | адрес / значение | ? | Логическое "ИЛИ" между аккумулятором и значением из памяти с последующей записью результата в аккумулятор. |
| jmp | Jump |  | ? | Безусловное изменение значения регистра-указателя команд на  |  
| jz |  
| jnz |  
| je |  
| jne |  
| j... |  
| int | interuption |  | ? | Вызов определенного вектора прерываний |  
| eni | enable interution |  | ? | Разрешить прерывания |  --возможно лишнее
| dii | disable interuption |  | ? | Запретить прерывания |  --возможно лишнее

## Кодирование инструкций

- Машинный код сериализуется в список формата JSON.
- Один элемент списка - одна машинная инструкция.
- Индекс списка - адрес инструкции в памяти. Используется для команд перехода.

Пример:

``` machine code
[
    {
        "opcode": "jmp",
        "arg": 2,
        "position": 5
    }
]
```

В примере, представленом выше:

- opcode - строка с кодом инструкции.
- arg - аргумент, если имеется.
- position - местоположение инструкции в исходном коде программы.

Типы данных для реализации инструкций (файл [isa.py](/src/isa.py)):

- Opcode - перечисление кодов инструкций.
- InstructionPosition - структура для описания местоположения позиции инструкции в исходном коде. ???

